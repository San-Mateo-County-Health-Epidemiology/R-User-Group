# mutate across variables
Beth Jump
2023-05-25

## Overview

`mutate(across(...))` allows you to perform an action on multiple
columns at once. Think: replacing 0’s in numeric columns, recoding
categorical string variables or making all string variables into
factors.

It is not for summing across variables or collapsing variables. If you
want to sum across variables or collapse multiple variables into one,
consider reshaping your data with `pivot_longer()` and then using
`group_by()` and `summarize()`.

## Using `mutate(across(....))`

This is the syntax for mutating across variables:

    mutate(across(<variables>), ~ function(.x))

- `<variables>`: this is where you specify the variables for the
  function. The `dplyr::select()` helper functions are quite useful for
  this. More on those
  [here](https://github.com/San-Mateo-County-Health-Epidemiology/R-User-Group/blob/main/quarto-markdowns/dynamic-selecting.md).
- `.x`: is the notation for telling R to perform the function on all
  variables specified in `across()`.

Let’s start by loading our data.

``` r
library(tidyverse)
library(lubridate)

data <- palmerpenguins::penguins
glimpse(data)
```

    Rows: 344
    Columns: 8
    $ species           <fct> Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adel…
    $ island            <fct> Torgersen, Torgersen, Torgersen, Torgersen, Torgerse…
    $ bill_length_mm    <dbl> 39.1, 39.5, 40.3, NA, 36.7, 39.3, 38.9, 39.2, 34.1, …
    $ bill_depth_mm     <dbl> 18.7, 17.4, 18.0, NA, 19.3, 20.6, 17.8, 19.6, 18.1, …
    $ flipper_length_mm <int> 181, 186, 195, NA, 193, 190, 181, 195, 193, 190, 186…
    $ body_mass_g       <int> 3750, 3800, 3250, NA, 3450, 3650, 3625, 4675, 3475, …
    $ sex               <fct> male, female, female, NA, female, male, female, male…
    $ year              <int> 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007…

### Change every variable

Here we’ll make every column into character:

``` r
data %>%
  mutate(across(everything(), ~ as.character(.x))) %>%
  glimpse() 
```

    Rows: 344
    Columns: 8
    $ species           <chr> "Adelie", "Adelie", "Adelie", "Adelie", "Adelie", "A…
    $ island            <chr> "Torgersen", "Torgersen", "Torgersen", "Torgersen", …
    $ bill_length_mm    <chr> "39.1", "39.5", "40.3", NA, "36.7", "39.3", "38.9", …
    $ bill_depth_mm     <chr> "18.7", "17.4", "18", NA, "19.3", "20.6", "17.8", "1…
    $ flipper_length_mm <chr> "181", "186", "195", NA, "193", "190", "181", "195",…
    $ body_mass_g       <chr> "3750", "3800", "3250", NA, "3450", "3650", "3625", …
    $ sex               <chr> "male", "female", "female", NA, "female", "male", "f…
    $ year              <chr> "2007", "2007", "2007", "2007", "2007", "2007", "200…

### Change only variables of a certain type

Here we’ll only make the factor variables into a characters:

``` r
data %>%
  mutate(across(where(is.factor), ~ as.character(.x))) %>%
  glimpse()
```

    Rows: 344
    Columns: 8
    $ species           <chr> "Adelie", "Adelie", "Adelie", "Adelie", "Adelie", "A…
    $ island            <chr> "Torgersen", "Torgersen", "Torgersen", "Torgersen", …
    $ bill_length_mm    <dbl> 39.1, 39.5, 40.3, NA, 36.7, 39.3, 38.9, 39.2, 34.1, …
    $ bill_depth_mm     <dbl> 18.7, 17.4, 18.0, NA, 19.3, 20.6, 17.8, 19.6, 18.1, …
    $ flipper_length_mm <int> 181, 186, 195, NA, 193, 190, 181, 195, 193, 190, 186…
    $ body_mass_g       <int> 3750, 3800, 3250, NA, 3450, 3650, 3625, 4675, 3475, …
    $ sex               <chr> "male", "female", "female", NA, "female", "male", "f…
    $ year              <int> 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007…

Here we’ll make all of the factor variables into characters and will
make the text all upper case:

``` r
data %>%
  mutate(across(where(is.factor), ~ str_to_upper(as.character(.x)))) %>%
  glimpse()
```

    Rows: 344
    Columns: 8
    $ species           <chr> "ADELIE", "ADELIE", "ADELIE", "ADELIE", "ADELIE", "A…
    $ island            <chr> "TORGERSEN", "TORGERSEN", "TORGERSEN", "TORGERSEN", …
    $ bill_length_mm    <dbl> 39.1, 39.5, 40.3, NA, 36.7, 39.3, 38.9, 39.2, 34.1, …
    $ bill_depth_mm     <dbl> 18.7, 17.4, 18.0, NA, 19.3, 20.6, 17.8, 19.6, 18.1, …
    $ flipper_length_mm <int> 181, 186, 195, NA, 193, 190, 181, 195, 193, 190, 186…
    $ body_mass_g       <int> 3750, 3800, 3250, NA, 3450, 3650, 3625, 4675, 3475, …
    $ sex               <chr> "MALE", "FEMALE", "FEMALE", NA, "FEMALE", "MALE", "F…
    $ year              <int> 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007…

### Change only variables with a certain name

Here we’ll change any variable ending in `_mm` to a numeric type:

``` r
data %>%
  mutate(across(matches("_mm$"), ~ as.numeric(.x))) %>%
  glimpse()
```

    Rows: 344
    Columns: 8
    $ species           <fct> Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adel…
    $ island            <fct> Torgersen, Torgersen, Torgersen, Torgersen, Torgerse…
    $ bill_length_mm    <dbl> 39.1, 39.5, 40.3, NA, 36.7, 39.3, 38.9, 39.2, 34.1, …
    $ bill_depth_mm     <dbl> 18.7, 17.4, 18.0, NA, 19.3, 20.6, 17.8, 19.6, 18.1, …
    $ flipper_length_mm <dbl> 181, 186, 195, NA, 193, 190, 181, 195, 193, 190, 186…
    $ body_mass_g       <int> 3750, 3800, 3250, NA, 3450, 3650, 3625, 4675, 3475, …
    $ sex               <fct> male, female, female, NA, female, male, female, male…
    $ year              <int> 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007…

### Using `mutate(across)` with “normal” `mutate()` steps

You can include “normal” mutate steps in the same `mutate()` function
call as a `mutate(across())`. Here we are replacing all numeric missing
values with 0’s and are recoding the `sex` variable:

``` r
data %>%
  mutate(across(where(is.numeric), ~ replace_na(.x, 0)),
         sex = case_when(is.na(sex) ~ "unknown",
                         TRUE ~ sex)) %>%
  glimpse()
```

    Rows: 344
    Columns: 8
    $ species           <fct> Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adel…
    $ island            <fct> Torgersen, Torgersen, Torgersen, Torgersen, Torgerse…
    $ bill_length_mm    <dbl> 39.1, 39.5, 40.3, 0.0, 36.7, 39.3, 38.9, 39.2, 34.1,…
    $ bill_depth_mm     <dbl> 18.7, 17.4, 18.0, 0.0, 19.3, 20.6, 17.8, 19.6, 18.1,…
    $ flipper_length_mm <int> 181, 186, 195, 0, 193, 190, 181, 195, 193, 190, 186,…
    $ body_mass_g       <int> 3750, 3800, 3250, 0, 3450, 3650, 3625, 4675, 3475, 4…
    $ sex               <chr> "male", "female", "female", "unknown", "female", "ma…
    $ year              <int> 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007…
