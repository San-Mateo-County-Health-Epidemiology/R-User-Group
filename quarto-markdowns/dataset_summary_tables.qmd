---
format: gfm
title: "Dataset summary tables using the Table One package "
author: "Julie Bartels"
date: "2025-09-18"
---

The **tableone** package in R can be used to make a summary table to describe your dataset. In epidemiology, this is commonly referred to as "Table 1", because it is usually the first table in a journal article describing the population under study. A bit more about Table 1 here: https://pubmed.ncbi.nlm.nih.gov/31229583/.

You could calculate these summary statistics manually (or use the summary function), but this package quickly does these calculations and formats them nicely into a table.

## Load libraries

```{r, output = FALSE}
library(dplyr)
library(tidyverse)
library(smcepi) #devtools::install_github("San-Mateo-County-Health-Epidemiology/smcepi")
library(tableone)
library(kableExtra)
library(flextable)
```

## Load data

```{r}
data <- palmerpenguins::penguins
glimpse(data)
```
There are 8 variables in the palmer penguins dataset. Three of them (species, island, and sex) are factors, meaning they have a certain number of levels or potential categorical values. Four of them are treated as continuous variables in the dataset (bill length, bill depth, flipper length, and body mass), and then we have year, which we will treat here as a factor variable with a distinct number of levels (or years). Some variables have missing (NA) values.

## Format data to create Table 1

**Tableone** requires us to use a vector of variables, which is the names of the variables in our dataframe. It also requires us to specify a vector of factor variables, because these factor (or categorical) variables are treated differently in the table (we calculate counts/proportions instead of mean/SD).

```{r}
vars <- c("species", "island", "bill_length_mm", "bill_depth_mm", "flipper_length_mm",
          "body_mass_g", "sex", "year")
factor_vars <- c("species", "island", "sex", "year")
```

## Create Table 1 output

Within the function to create the table, at minimum, we need to specify the variables in our dataframe, the factor variables, and the dataset to be used.

```{r}
CreateTableOne(
  vars = vars,
  factorVars = factor_vars,
  data = data, 
  includeNA = FALSE # Change to TRUE to include missing (NA) as a regular factor level for factor variables
  )
```

We see here that factor variables have a count and proportion of subjects with each characteristic, and that for continuous variables, we are given the mean and standard deviation.

## Create Table 1 output with stratification

That was a very simple table - now we will stratify the table by the "exposure" variable, which in our case is defined as the specific island within the Archipelago.

To do so, we need to redefine our variables and factor variables, but exclude "island" from those lists.

```{r}
# Re-define vars and factor_vars vectors WITHOUT stratifying variable "island"
vars <- c("species", "bill_length_mm", "bill_depth_mm", "flipper_length_mm",
          "body_mass_g", "sex", "year")
factor_vars <- c("species", "sex", "year")
```

Now, when we run our **CreateTableOne()** function, we define the strata as "island". Note here that we have a few other items defined:

- **test = FALSE.** If this were set to true, statistical groupwise comparisons would be run to compare the groups in the stratified variable, with p-values added to the table. More about this is available in the function notes (command: ?CreateTableOne()). 
    - There is a lot of discussion about whether p-values or statistical tests should be included in Table 1: https://epitodate.com/the-balance-test-fallacy-why-you-shouldnt-put-p-values-in-table-1/.

- **addOverall = TRUE.** We use this to add an overall column (not stratified) to the table.

```{r}
table1 <- CreateTableOne(
  vars = vars,
  factorVars = factor_vars,
  strata = "island", 
  data = data, 
  test = FALSE, # Change to TRUE to get chi.sq and ANOVA results
  addOverall = TRUE)
```

Above, we see that for factor variables with two levels (like sex), we only see one row in the table, for the count and proportion of penguins in each group that are male. If you want to change this to see only the penguins that are female, you can reset the order of the levels in the factor (the default is alphabetical).

```{r, eval = FALSE}
data$sex <- factor(data$sex, levels = c("male", "female"))
```

If we want to see the count and proportion for both male and female penguins, we can print the table and set **showAllLevels = TRUE**.

```{r}
print(table1, showAllLevels = TRUE)
```

You can save this table as a csv so that you can edit it and use the calculations elsewhere.

```{r, eval = FALSE}
table1_output <- print(table1, showAllLevels = TRUE, 
                      printToggle = FALSE, # This prevents the table from printing below
                      contDigits = 1, # Round to 1 decimal place for continuous variables
                      noSpaces = TRUE # Remove extra spaces from dataframe
)
write.csv(table1_output, file = "table1_output.csv")
```

## Formatting Table 1 output

You may also want to include this table as a formatted output in a rendered Quarto document, in which case you first clean up some of the formatting, as below, in a dataframe.

```{r, output = FALSE}
# Clean table
table1_format <- as.data.frame(print(table1, 
                                     showAllLevels = TRUE, 
                                     printToggle = TRUE,
                                     contDigits = 1,
                                     noSpaces = TRUE
                                     )) %>%
  rename("Characteristic" = "level") %>%
  mutate(Category = rownames(.)) %>%
  select(c(Category, Characteristic, Overall, Biscoe, Dream, Torgersen))
# Remove rownames from the table
rownames(table1_format) <- NULL

table1_format <- table1_format %>%
  mutate(Category = c("N", "Species", "Species", "Species", 
                      "Measurements", "Measurements", "Measurements", "Measurements",
                      "Sex", "Sex",
                      "Year", "Year", "Year"),
         Characteristic = c("n", "Adelie", "Chinstrap", "Gentoo", 
                            "Bill Length, mm", "Bill Depth, mm", "Flipper Length, mm", "Body mass, g",
                            "Female", "Male",
                            "2007", "2008", "2009"))
```

You can make a flextable, and then export the flextable as a png to add to reports, send to collaborators, etc. 

```{r}
table1_format_flex <- as_grouped_data(table1_format, groups = "Category") %>%
  as_flextable(hide_grouplabel = TRUE) %>% 
  set_header_labels(what = "") %>% 
  bold(bold = TRUE, part=c("header")) %>% 
  align(i = ~ !is.na(Category), align = "left") %>% 
  bold(i = ~ !is.na(Category)) %>%
  add_header_row(., top = TRUE, 
                     values = c("", "Island"), 
                     colwidths = c(2, 3)) %>%
  align(align = "center", part = "header") %>%
  autofit()

table1_format_flex
```
Save the table as a png.

```{r, eval = FALSE}
save_as_image(table1_format_flex, path = "table1.png")
```

