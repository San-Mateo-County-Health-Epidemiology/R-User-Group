---
format: gfm
title: "Download Healthy Places Index Data using API"
author: "Julie Bartels"
date: "2025-08-21"
execute:
  eval: FALSE
---

## Overview

This document provides functions to streamline the download of Healthy Places Index 3.0 data, including the 23 indicators that are used for the Index, as well as selected indicators for the Decision Support part of the HPI tool.

Users will need to create an individual API key here: https://map.healthyplacesindex.org/?redirect=false. Click **Sign In** in the upper right hand corner to create an account.  

This code can be adapted and applied for other APIs and data sources.

### Load libraries

```{r, eval = FALSE}
library(httr)
library(jsonlite)
library(readr)
library(dplyr)
library(stringr)
library(purrr)
```

### Create list of census tracts in San Mateo County

This is used to filter HPI data for census tracts in SMC later in the process. It relies on uploading a file that includes the census tracts that were used for the HPI overall index ranks for census tracts in SMC.

```{r, eval = FALSE}
hpi_ranks_smc_censustracts <- read_csv("J:/Epi Data/HPI 3.0/Data/HPI_ranks_SMC_censustracts.csv")

smc_censustracts <- hpi_ranks_smc_censustracts %>%
  select(geoid, name) %>%
  mutate(geoid = as.character(geoid), 
         name = as.character(name))
```

## Downloading and cleaning HPI data

### Inputs to download and clean datasets for HPI indicators only

The vectors below are hand-coded with values for each of the variables we are pulling from the HPI.

Line 52 ("api_key") requires the user to input their own API key as a character there.

```{r, eval=FALSE}
url <- "https://api.healthyplacesindex.org/api/hpi"
api_key <- "YOUR API KEY HERE"
geography <- "tracts"

year <- c("2019", "2019", "2019", "2019", "2019", "2019", "2020", "2020", "2019",
          "2019", "2017", "2021", "2011", "2019", "2017", "2017", "2017", "2019",
          "2016", "2019", "2018", "2017", "2019")

indicator <- c("abovepoverty", "employed", "percapitaincome", "bachelorsed", "inhighschool",
               "inpreschool", "censusresponse", "voting", "commute", "automobile", "parkaccess",
               "retail", "treecanopy", "homeownership", "houserepair", "ownsevere", "rentsevere",
               "uncrowded", "dieselpm", "h20contam", "ozone", "pm25", "insured")

format <- "json"

# combine year and indicator data into dataframe
hpi_vars <- data_frame("geography" = geography,
                       "year" = year,
                       "indicator" = indicator,
                       "format" = format)

```
## Pull and collate HPI indicator datasets

Here we'll loop through the variables saved above. We'll save the year and indicator as variables in our data set and will append each API call so the data are stored in a long format. 

**You may run into rate limit errors when running the loop and might need to only pull a few indicators at a time. Sometimes this runs without error.**

```{r, eval=FALSE}
all_data <- data.frame()

for (i in 1:nrow(hpi_vars)) {
  
  print(paste0(hpi_vars[i, 3], ", ", hpi_vars[i, 2]))
  
  params <- list(geography = paste(hpi_vars[i, 1]),
                 year = paste(hpi_vars[i, 2]),
                 indicator = paste(hpi_vars[i, 3]),
                 format = paste(hpi_vars[i, 4]), 
                 key=api_key)
  
  res <- GET(url,query=params)  
  
  data <- as.data.frame(fromJSON(rawToChar(res$content))) 
  
  data1 <- data %>% 
    mutate(year = paste(hpi_vars[i, 2]),
           indicator = paste(hpi_vars[i, 3]))
  
  all_data <- all_data %>%
    bind_rows(data1)
}
```

Then we can do some cleaning to remove unnecessary variables and add new ones:

```{r}
smc_data <- all_data %>%
  select(-c(numerator, denominator, se)) %>%
  mutate(quantile = case_when(percentile <= 0.25 ~ 1, 
                              percentile <= 0.5 & percentile > 0.25 ~ 2,
                              percentile <= 0.75 & percentile > 0.5 ~ 3,
                              percentile <= 1 & percentile > 0.75 ~ 4)) %>% 
   filter(name %in% smc_censustracts$name)
```

## Inputs to download and clean datasets for selected Decision Support indicators

The HPI includes 23 main indicators, as well as others that are in the "Decision Support" section. Here, we create indicator and year vectors that are relevant to those decision support indicators, as labeled throughout the following code chunk.

The user will need to input their api_key here as well. Note that the URL here is slightly different from the previous one.

```{r, eval = FALSE}
url_ds <- "https://api.healthyplacesindex.org/api/support"
api_key <- "YOUR API KEY HERE"
geography_ds <- "tracts"
year_ds <- c("2019", # Race/Ethnicity Diversity Index 2019
          "2010", # Residential segregation (all Non-White) 2010
          "2010", # Residential segregation (Asian) 2010
          "2010",  # Residential segregation (Black or African American) 2010
          "2010", # Residential segregation (Hispanic or Latino) 2010
          "2016", # Impervious surface cover 2016
          "2015", # Urban heat island index 2015
          "2018", # Extreme heat days above 100 degrees (2035-2064)
          "2018", # Extreme heat days above 100 degrees (2035-2064) - above historical baseline
          "2009", # Population in Sea Level Rise Inundation Area - 2009
          "2007", # Wildfire Risk - 2007
          "2019", # Households with Broadband Internet 2019
          "2019", # New Residents 2019
          "2015", # Park Acres 2015
          "2017", # Supermarket Access 2017
          "2017", # Traffic Impacts 2017
          "2012", # Transit Access 2012
          "2018", # Walkability Score 2018
          "2019", # Ambulatory Difficulty 2019
          "2018", # Asthma Percent 2018
          "2018", # Cancer (except skin cancer) Percent 2018
          "2018", # Cognitive difficulty Percent 2018
          "2018", # Coronary heart disease Percent 2018
          "2018", # Diagnosed Diabetes Percent 2018
          "2019", # Hearing Difficulty 2019,
          "2018", # High Blood Pressure Percent 2018
          "2015", # Life Expectancy at Birth 2015
          "2018", # Low Birthweight Infants 2018
          "2018", # Mental Health Not Good 2018
          "2018", # Obesity 2018
          "2019", # Self-Care Difficulty 2019
          "2019", # Vision Difficulty 2019
          "2018", # Binge Drinking 2018
          "2019", # Children in Poverty 2019
          "2019", # Older Adults 65+ Below Poverty 2019
          "2019", # Older Adults 65+ Living Alone 2019
          "2016", # Students Eligible for Free and Reduced Meal Program 2016
          "2018" # Social Vulnerability Index 2018
)

indicator_ds <- c("diversity_index", # Race/Ethnicity Diversity Index 2019
               "iod_nonwhite", # Residential segregation (all Non-White) 2010
               "iod_asian", # Residential segregation (Asian) 2010
               "iod", # Residential segregation (Black or African American) 2010
               "iod_latino", # Residential segregation (Hispanic or Latino) 2010
               "impervsurf", # Impervious surface cover 2016
               "uhii", # Urban heat island index 2015
               "daysabove100f_2035_2064", # Extreme heat days above 100 degrees (2035-2064)
               "eh_rcp8.5_2035_2064", # Extreme heat days above 100 degrees (2035-2064) - above historical baseline
               "sealevel", # Population in Sea Level Rise Inundation Area - 2009
               "wildfire", # Wildfire Risk - 2007
               "broadband", # Households with Broadband Internet 2019
               "recentmove", # New Residents 2019
               "parkacres_per1000", # Park Acres 2015
               "supermkts", # Supermarket Access 2017
               "traffic_impacts", # Traffic Impacts 2017
               "transitaccess", # Transit Access 2012
               "walkability", # Walkability Score 2018
               "difficultyambulatory", # Ambulatory Difficulty 2019
               "casthma", # Asthma Percent 2018
               "cancer", # Cancer (except skin cancer) Percent 2018
               "difficultycognitive", # Cognitive difficulty Percent 2018
               "chd", # Coronary heart disease Percent 2018
               "diabetes", # Diagnosed Diabetes Percent 2018
               "difficultyhearing", # Hearing Difficulty 2019,
               "bphigh", # High Blood Pressure Percent 2018
               "leb", # Life Expectancy at Birth 2015,
               "lbw", # Low Birthweight Infants 2018
               "mhlth", # Mental Health Not Good 2018
               "obesity", # Obesity 2018
               "difficultyselfcare", # Self-Care Difficulty 2019
               "difficultyvision", # Vision Difficulty 2019
               "binge", # Binge Drinking 2018
               "childpoverty", # Children in Poverty 2019
               "poverty65", # Older Adults 65+ Below Poverty 2019
               "livealone65", # Older Adults 65+ Living Alone 2019
               "frm", # Students Eligible for Free and Reduced Meal Program 2016
               "svi" # Social Vulnerability Index 2018
)

format_ds <- "json"

# combine year and indicator data into dataframe
decision_support_vars <- data_frame("geography" = geography_ds,
                       "year" = year_ds,
                       "indicator" = indicator_ds,
                       "format" = format_ds)

```

